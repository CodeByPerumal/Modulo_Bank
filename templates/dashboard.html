{% extends "base.html" %}
{% block title %}Dashboard - Modulo Bank{% endblock %}
<!-- Include Notifications Dropdown -->

{% block content %}
{% include "notify/notifications_dropdown.html" %}
<section class="container py-5">
  <h2 class="fw-bold text-primary text-center mb-4">Welcome Back to Modulo Bank</h2>
  <p class="text-center text-muted mb-5">Here‚Äôs an overview of your financial activity and insights.</p>
{% if user.is_staff %}
<a href="{% url 'admin-user-list-page' %}" class="btn btn-info mt-3">
  üë§ Manage Users
</a>
{% endif %}



  <!-- Summary Cards -->
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm border-primary">
      <div class="card-body text-center">
        <h3 class="fw-bold text-primary">{{ total_accounts }}</h3>
        <a href="{% url 'accounts-list' %}" class="btn btn-outline-primary btn-sm mt-2">
          View Accounts
        </a>

      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-success">
      <div class="card-body text-center">
        <h6 class="text-uppercase text-muted">Total Balance</h6>
        <h3 class="fw-bold text-success">‚Çπ{{ total_balance }}</h3>
      </div>
    </div>
  </div>

<div class="col-md-3">
  <div class="card shadow-sm border-danger">
    <div class="card-body text-center">
      <h6 class="text-uppercase text-muted">Fraud Alerts</h6>
      <h3 class="fw-bold text-danger">{{ fraud_alerts }}</h3>
    </div>
  </div>
</div>



  <div class="col-md-3">
    <div class="card shadow-sm border-info">
      <div class="card-body text-center">
        <h6 class="text-uppercase text-muted">Actions</h6>
        <a href="{% url 'accounts-create' %}" class="btn btn-info btn-sm text-white mt-2">
          + Open Account
        </a>
      </div>
    </div>
  </div>
</div>

  <!-- Loan Buttons -->
  <div class="d-flex gap-2 mb-4">
    <a href="{% url 'loan-apply' %}" class="btn btn-warning">
      üí∞ Apply for Loan
    </a>
    <a href="{% url 'my-loans' %}" class="btn btn-secondary">
      üìÑ View My Loans
    </a>
  </div>

<a href="{% url 'transactions-page' %}" class="btn btn-outline-primary mt-3">
  üí∏ View / Make Transactions
</a>


<!-- admin Loan panel -->

{% if user.is_staff %}
<!-- Pending Loan Approvals (Admin Only) -->
<h5 class="mt-5 text-primary">Pending Loan Approvals</h5>
<table class="table table-striped table-sm">
  <thead>
    <tr>
      <th>Loan Type</th>
      <th>User</th>
      <th>Account</th>
      <th>Principal</th>
      <th>EMI</th>
      <th>Term (Months)</th>
      <th>Status</th>
      <th>Applied On</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for loan in pending_loans %}
    <tr>
      <td>{{ loan.loan_type }}</td>
      <td>{{ loan.user.username }}</td>
      <td>{{ loan.account.account_number }}</td>
      <td>‚Çπ{{ loan.principal_amount }}</td>
      <td>‚Çπ{{ loan.emi }}</td>
      <td>{{ loan.term_months }}</td>
      <td>{{ loan.status }}</td>
      <td>{{ loan.created_at|date:"Y-m-d H:i" }}</td>
      <td class="d-flex gap-1">
        <!-- Approve Button -->
        <form method="POST" action="{% url 'loan-approval-action' loan.id %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="APPROVE">
          <button type="submit" class="btn btn-sm btn-success">‚úÖ Approve</button>
        </form>

        <!-- Reject Button -->
        <form method="POST" action="{% url 'loan-approval-action' loan.id %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="REJECT">
          <button type="submit" class="btn btn-sm btn-danger">‚ùå Reject</button>
        </form>
      </td>
    </tr>
    {% empty %}
      <tr><td colspan="9" class="text-muted text-center">No pending loans</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<!-- Notifications Panel -->
<div class="card shadow-sm mt-4">
  <div class="card-header bg-warning fw-semibold">
    Notifications
    {% if unread_count > 0 %}
      <span class="badge bg-danger">{{ unread_count }}</span>
    {% endif %}
  </div>
  <div class="card-body">
    <ul class="list-group list-group-flush">
      {% for n in notifications %}
        <li class="list-group-item {% if not n.is_read %}fw-bold{% endif %}">
          {{ n.title }} - {{ n.message }}
          <small class="text-muted d-block">{{ n.created_at|date:"M d, Y H:i" }}</small>
        </li>
      {% empty %}
        <li class="list-group-item text-muted">No notifications</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% comment %} 
  <!-- Recent Transactions -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white fw-semibold">Recent Transactions</div>
    <div class="card-body p-0">
      <table class="table mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Type</th>
            <th>Status</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>03 Nov 2025</td>
            <td>Deposit - Salary</td>
            <td><span class="badge bg-success">Deposit</span></td>
            <td><span class="badge bg-success">Success</span></td>
            <td>‚Çπ75,000</td>
          </tr>
          <tr>
            <td>02 Nov 2025</td>
            <td>Electricity Bill</td>
            <td><span class="badge bg-danger">Withdrawal</span></td>
            <td><span class="badge bg-success">Success</span></td>
            <td>‚Çπ1,200</td>
          </tr>
          <tr>
            <td>01 Nov 2025</td>
            <td>Transfer to Savings</td>
            <td><span class="badge bg-info text-dark">Transfer</span></td>
            <td><span class="badge bg-success">Success</span></td>
            <td>‚Çπ5,000</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div> {% endcomment %}


{% if user.is_staff %}
<a href="{% url 'audit-logs' %}" class="btn btn-warning mt-3">
  üìù View Audit Logs
</a>
{% endif %}




  <!-- Notifications -->
  <div class="card shadow-sm">
    <div class="card-header bg-warning fw-semibold">Recent Notifications</div>
    <div class="card-body">
      <ul class="list-group list-group-flush">
        <li class="list-group-item text-muted">
          <strong>Security Update:</strong> We‚Äôve enhanced your account protection features.
        </li>
        <li class="list-group-item text-muted">
          <strong>New Offer:</strong> Earn cashback on every UPI transaction.
        </li>
        <li class="list-group-item text-muted">
          <strong>System Maintenance:</strong> Scheduled downtime on Nov 10, 2025 (1 AM‚Äì3 AM).
        </li>
      </ul>
    </div>
  </div>

  <h5 class="mt-4 text-warning">Recent Transactions</h5>
<table class="table table-sm">
  <thead>
    <tr>
      <th>Date</th>
      <th>From</th>
      <th>To</th>
      <th>Amount</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    {% for t in recent_transactions %}
      <tr>
        <td>{{ t.timestamp|date:"M d, Y H:i" }}</td>
        <td>{{ t.sender.account_number }}</td>
        <td>{{ t.receiver.account_number }}</td>
        <td>‚Çπ{{ t.amount }}</td>
        <td>{{ t.status }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="5" class="text-muted text-center">No recent transactions</td></tr>
    {% endfor %}
  </tbody>
</table>

</section>
{% endblock %}
